"use strict";function demo(t){dat[1]="#测试数据\n#i   均匀随机数 正态随机数\n 0.0      0.307     -0.355\n 0.5      0.151     -0.856\n 1.0      0.263     -0.889\n 1.5      0.315     -0.021\n 2.0      0.478     -1.454\n 2.5      0.655      1.192\n 3.0      0.889     -0.474\n 3.5      0.331     -0.182\n 4.0      0.965     -0.512\n 4.5      0.302     -0.447\n 5.0      0.554      2.187\n 5.5      0.075     -1.225\n 6.0      0.576      0.577\n 6.5      0.920      1.232\n 7.0      0.573     -0.777\n 7.5      0.237     -0.204\n 8.0      0.131      0.304\n 8.5      0.616      0.960\n 9.0      0.042     -0.473\n 9.5      0.128     -0.780\n10.0      0.135      0.655",cmd[1]="1:2 @O\n[2:8] [-3:3] 1:3 @M~\n$1:$2*2 @O10-.5\n$1:exp(sin($3)) @A10~1",dat[2]="0.25  19.21\n0.5   18.15\n1     15.36\n1.5   14.10\n2     12.89\n3      9.32\n4      7.45\n6      5.24\n8      3.01",cmd[2]="1:2 @O\nfun [0:10] 20*exp(-.2*x) @~3\nfit $2=a*exp(-b*$1) a==20 b=.2 @M~",dat[3]="",cmd[3]="min 100*(x2-x1*x1)^2/2+(1-x1)^2/2 x1=-1.2  x2=1 @O\nmin {sqrt(2)*10*(x2-x1*x1); sqrt(2)*(1-x1)} x1=-1.2  x2=1 @M\n#min sqrt(2)*sqrt(100*(x2-x1*x1)^2+(1-x1)^2) x1=-1.2  x2=1 @A",$("data").value=dat[t],$("cmd").value=cmd[t],runCMD()}function noShow(t){$(t).style.display="none"}function showLM(){$("LM").style.display="block"}function runCMD(){LMret="";var i,j,k,ii,jj,row,col,txt,str,tips="数据";txt=trim($("data").value).split(/\n/);var legend=[];for(i=-1,"#"==trim(txt[0])[0]&&(i=0,"#"==trim(txt[1])[0]&&(i=1)),i>=0&&(1==i&&(tips=trim(txt[0].slice(1))),legend=trim(txt[i].slice(1)).split(/\s+/),txt=txt.slice(i+1)),row=txt.length,col=1,i=0;i<row;i++)txt[i]=trim(txt[i]),(j=txt[i].split(/\s+/).length)>col&&(col=j);var minDat=[],maxDat=[];for(i=0;i<col;i++)minDat[i]=HUGE,maxDat[i]=-HUGE;for(i=0;i<row;i++)for(data[i]=[],str=txt[i].split(/\s+/),col=str.length,j=0;j<col;j++)data[i][j]=parseFloat(str[j]),data[i][j]<minDat[j]&&(minDat[j]=data[i][j]),data[i][j]>maxDat[j]&&(maxDat[j]=data[i][j]);if(txt=trim($("cmd").value.replace(/#.*/g,"").replace(/@ +/g,"@"))){txt=txt.split(/\n/);var nser=txt.length,xname="",yname="",xmin=0,xmax=0,ymin,ymax,dx=1,isDat,isFun,isFit,isMin,isLSQ,Imin,series=[],ptype=[],ltype=[],swid=[],sname=[],smooth=[],symbol=[],ssymbol=[],x,y,ix=0,iy=-1,fx="",fy="",px=[],popt=[],nfit,fit=[],fitDat=[];for(k=0;k<nser;k++){if(series[k]=[],isDat=!0,isFun=!1,isFit=!1,isMin=!1,isLSQ=!1,Imin=0,str=trim(txt[k]),"fun"==str.substr(0,3)&&(isFun=!0),"fit"==str.substr(0,3)&&(isFit=!0),"min"==str.substr(0,3)&&(isMin=!0,Imin=1,-1!=str.indexOf("{")&&(isLSQ=!0,Imin=2,isMin=!1)),(isFun||isFit||isMin||isLSQ)&&(isDat=!1),str=str.replace(/^fun\s+/,"").replace(/^fit\s+/,"").replace(/^min\s+/,""),str=str.replace(/\s+:\s+/g,":").replace(/\s+=+\s+/g,"=").replace(/\s+;\s+/g,";"),fx=-1==str.indexOf("@")||trim(str.replace(/^.*@/,"")).length<1?"O-":trim(str.replace(/^.*@/,"")),ptype[k]=plotType(fx),ltype[k]=lineType(fx),smooth[k]=smline(fx),symbol[k]=stype(fx),swid[k]=sizewidth(fx),str=str.replace(/\s*@.*/,""),xmin=-HUGE,xmax=HUGE,ymin=-HUGE,ymax=HUGE,isFun&&(xmin=-10,xmax=10),-1!=str.indexOf("]")){var range=trim(str.replace(/][^\]]*$/,"").replace(/\[/g,"")).split(/]/);if(range.length){var xrange=trim(range[0]).split(/:/);xmin=isNaN(xrange[0])?xmin:parseFloat(xrange[0]),xmax=isNaN(xrange[1])?xmax:parseFloat(xrange[1]),dx=isNaN(xrange[2])?(xmax-xmin)/10:parseFloat(xrange[2]),2==range.length&&(xrange=trim(range[1]).split(/:/),ymin=isNaN(xrange[0])?ymin:parseFloat(xrange[0]),ymax=isNaN(xrange[1])?ymax:parseFloat(xrange[1]))}}if(str=trim(str.replace(/^.*]\s*/,"")),isFun)for(xname+="x",yname+="f(x)",sname[k]=str,fx=new Function("x","return "+mathFunction(str)),x=xmin;x<=xmax;x+=dx)series[k].push([x,fx(x)]);if(isDat)for(str=str.split(/:/),ix=-1,iy=-1,fx="",fy="",-1==str[0].indexOf("$")?ix=parseInt(str[0])-1:fx=trim(str[0]),-1==str[1].indexOf("$")?iy=parseInt(str[1])-1:fy=trim(str[1]),fx.length>1?xname+=fx:xname+=legend[ix]?legend[ix]:"x"+(ix+1),fy.length>1?sname[k]=fy:sname[k]=legend[iy]?legend[iy]:"x"+(iy+1),yname+=sname[k],i=0;i<row;i++){ix>=0?x=data[i][ix]:(x=fx.replace(/\$(\d+)/g,"data["+i+"][$1-1]"),x=eval(mathFunction(x))),iy>=0?y=data[i][iy]:(y=fy.replace(/\$(\d+)/g,"data["+i+"][$1-1]"),y=eval(mathFunction(y)));var xx=parseFloat(x),yy=parseFloat(y);xmin<=xx&&xx<=xmax&&ymin<=yy&&yy<=ymax&&series[k].push([x,y])}if(isFit||isMin||isLSQ){for(str=str.replace(/maxit=+/,"maxit==").replace(/tau=+/,"tau=="),str=str.replace(/tolg=+/,"tolg==").replace(/tolx=+/,"tolx=="),str=trim(str),isFit?(iy=parseInt(str.replace(/=.*$/,"").replace(/\$/,""))-1,yname+=legend[iy]?legend[iy]:"$"+(iy+1),str=trim(str.replace(/^[^=]*=/,""))):(xname+="优化步数",yname+="f(X)"),popt=str.split(/\s+/),str=str.split(/\s+/),fx="",i=0;i<str.length&&-1==str[i].indexOf("=");i++)fx+=str[i];if(sname[k]=fx,popt=popt.slice(i),isFit)for(fx=fx.replace(/\$/g,"__x"),str=fx.match(/__x\d+/g),ix=parseInt(str[0].replace(/__x/,""))-1,xname+=ix>=0&&legend[ix]?legend[ix]:"$"+(ix+1),str.sort(),px=[],ii=-1,i=0;i<str.length;i++)j=str[i],i&&ii===j||px.push(j),ii=j;var maxIter,tau,tolg,tolx;for(str=popt,popt=[],i=0;i<str.length;i++)if(-1==str[i].indexOf("=="))popt.push(str[i]);else{if(ii=trim(str[i].replace(/=.*/,"")),j=trim(str[i].replace(/.*=/,"")),-1!=ii.indexOf("maxit")){maxIter=j;continue}if(-1!=ii.indexOf("tau")){tau=j;continue}if(-1!=ii.indexOf("tolg")){tolg=j;continue}if(-1!=ii.indexOf("tolx")){tolx=j;continue}j="("+j+"*1.)",fx=fx.replace(new RegExp(ii,"g"),j)}if(isLSQ?(fx=trim(fx.replace(/[}{]/g,"")),fx=fx.split(/;/)):fx=[fx],isFit)for(nfit=0,i=0;i<row;i++)if(xmin<=data[i][ix]&&data[i][ix]<xmax){for(fitDat[nfit]=[],j=0;j<data[i].length;j++)fitDat[i][j]=data[i][j];nfit++}if(fit=LMopt(Imin,fitDat,iy,fx,px,popt,maxIter,tau,tolg,tolx),isFit)for(nfit=0,i=0;i<row;i++)xmin<=data[i][ix]&&data[i][ix]<xmax&&(x=data[i][ix],y=fit[nfit],series[k].push([x,y]),nfit++);else for(nfit=fit.length,i=0;i<nfit;i++)series[k].push([i,fit[i]])}xname+="｜",yname+="｜"}for(option.title.text=tips,option.xAxis.name=xname.replace(/｜$/,""),option.yAxis.name=yname.replace(/｜$/,""),option.series=[],k=0;k<nser;k++)option.series[k]={},option.series[k].name=sname[k],option.series[k].type=ptype[k],option.series[k].data=[],option.series[k].data=series[k],option.series[k].smooth=smooth[k],option.series[k].symbol=symbol[k],option.series[k].sampling="min",option.series[k].showSymbol=!!symbol[k],option.series[k].lineStyle={},option.series[k].lineStyle.type=ltype[k],option.series[k].symbolSize=swid[k].split(/\s+/)[0],option.series[k].lineStyle.width=swid[k].split(/\s+/)[1];myChart.setOption(option,!0)}}function LMopt(t,i,e,n,a,r,s,o,l,x){s=s||100,o=o||.001,l=l||1e-8,x=x||1e-12;var f,m,p,u,c,h=a.length,d=n.length,y=r.length,g=[],M=[],b=[],k=[],v=[],w={},F=1,j=[],L=[],S=e>-1&&h>0,O=1==t,I=2==t;if(I&&(d=n.length,F=d),O)for(d=1,F=1,f=0;f<y;f++)v[f]=[];if(S)for(d=1,F=i.length,f=0;f<h;f++)g[f]=parseInt(a[f].replace(/__x/,""))-1;for(f=0;f<y;f++)M[f]=parseFloat(trim(r[f].replace(/.*=+/,""))),b[f]=trim(r[f].replace(/=.*/,""));if(I)for(f=0;f<d;f++){for(k[f]=[],m=0;m<y;m++)k[f][m]=math.simplify(math.derivative(n[f],b[m])).compile();n[f]=math.compile(n[f])}else{for(n=n[0],p=n.replace(/__x/g,"$"),f=0;f<y;f++){if(k[f]=math.simplify(math.derivative(n,b[f])),O)for(m=0;m<y;m++)v[f][m]=math.simplify(math.derivative(k[f],b[m])).compile();k[f]=k[f].compile()}n=math.compile(n)}var D=[],A=[],H=[],z=[],N=[],T=[];for(f=0;f<y;f++)w[b[f]]=M[f];if(O){for(f=0;f<y;f++)A[f]=[];u=n.evaluate(w)}else{for(f=0;f<F;f++)if(H[f]=[],z[f]=[],I&&(j[f]=n[f].evaluate(w)),S){for(m=0;m<h;m++)w[a[m]]=i[f][g[m]];j[f]=n.evaluate(w)-i[f][e]}u=.5*math.dot(j,j)}var q,_,E,G,C,W=Math.pow(2,-52),Q=0,U=!1,Y=!0,P=2;for(LMret+='<tr align="center"><th>优化步数<br>k<'+s+"</th><th>目标函数值<br>f="+p+"</th><th>最大梯度<br>‖∇f‖<sub>∞</sub> < "+l+"</th><th>参数增比<br>‖ΔP‖<sub>2</sub>/‖P‖<sub>2</sub> < "+x+"</th><th>参数值<br>(",f=0;f<y;f++)LMret+=b[f]+(f==y-1?")":", ");for(LMret+="</th></tr>";!U&&Q<s;){if(Y){for(f=0;f<y;f++)w[b[f]]=M[f];if(O){for(f=0;f<y;f++)for(D[f]=k[f].evaluate(w),m=0;m<y;m++)A[f][m]=v[f][m].evaluate(w);if(0==Q){for(_=-1,f=0;f<y;f++){for(q=0,m=0;m<y;m++)q+=Math.abs(A[f][m]);q>_&&(_=q)}q=o*_,0==q&&(q=math.max(math.abs(D))/math.max(math.sqrt(math.dot(M,M),math.sqrt(W))))}}else{for(f=0;f<F;f++){if(I)for(m=0;m<y;m++)H[f][m]=k[f][m].evaluate(w);if(S){for(m=0;m<h;m++)w[a[m]]=i[f][g[m]];for(m=0;m<y;m++)H[f][m]=k[m].evaluate(w)}}z=math.transpose(H),D=math.multiply(z,j),A=math.multiply(z,H),0==Q&&(q=o*math.max(math.diag(A)))}}var Z,X,R,B,V,J=!1;if((_=math.max(math.abs(A)))<W)Z=math.multiply(-q,D);else{for(;!J;)for(B=math.add(A,math.multiply(q,math.identity(y))),V=math.eigs(B).values,J=!0,f=0;f<V.length;f++)if(V[f]<1e-15){J=!1,q=math.max(10*q,W*_);break}Z=math.add(A,math.multiply(q,math.identity(y))),Z=math.inv(Z),Z=math.multiply(-1,math.multiply(D,Z))}for(E=math.max(math.abs(D)),G=math.sqrt(math.dot(M,M)),C=math.sqrt(math.dot(Z,Z)),(E<=l||C<=x*(x+G))&&(U=!0),f=0;f<y;f++)N[f]=M[f]+parseFloat(Z.subset(math.index(f))),w[b[f]]=N[f];if(O)c=n.evaluate(w);else{for(f=0;f<F;f++)if(I&&(T[f]=n[f].evaluate(w)),S){for(m=0;m<h;m++)w[a[m]]=i[f][g[m]];L[f]=n.evaluate(w),T[f]=L[f]-i[f][e]}c=.5*math.dot(T,T)}if(X=math.subtract(math.multiply(q,Z),D),X=.5*math.multiply(math.transpose(Z),X),R=O?u-c:.5*math.dot(math.transpose(math.subtract(j,T)),math.add(j,T)),X>0&&R>0){for(u=c,Y=!0,f=0;f<y;f++)M[f]=N[f];for(f=0;f<F;f++)j[f]=T[f];q*=math.max(1/3,1-Math.pow(2*R/X-1,3)),P=2}else Y=!1,q*=P,P*=2;for(S||L.push(u),LMret+='<tr align="center"><td>'+Q+"</td><td>"+u+"</td><td>"+E+"</td><td>"+C/(x+G)+'</td><td align="left">(',f=0;f<y;f++)LMret+=M[f]+(f==y-1?"":", ");LMret+=")</td></tr>",Q++}return LMret+='<tr><td colspan="5" align="center"><button class="btn" onclick=\'noShow("LM")\'>关闭</button></td></tr>',$("LMret").innerHTML=LMret,L}function smline(t){return-1!=t.indexOf("~")}function plotType(t){return-1!=t.indexOf("-")||-1!=t.indexOf("~")?"line":"scatter"}function lineType(t){return-1!=t.indexOf(".")?"dotted":-1!=t.indexOf("--")?"dashed":"solid"}function sizewidth(t){var i,e;return i=trim(t.replace(/[.~-]+\d*/,"").replace(/[A-Z^]*/,"")),e=trim(t.replace(/[A-Z^]+\d*/,"").replace(/[.~-]*/,"")),i||(i=10),e||(e=2),i+" "+e}function stype(t){return-1!=t.indexOf("O")?"circle":-1!=t.indexOf("M")?"rect":-1!=t.indexOf("D")?"roundRect":-1!=t.indexOf("A")?"triangle":-1!=t.indexOf("V")?"diamond":-1!=t.indexOf("Q")?"pin":-1!=t.indexOf("^")?"arrow":""}function mathFunction(t){return t=t.replace(/pi/gi,"(Math.PI)").replace(/tau/gi,"(2*Math.PI)")}function abs(t){return Math.abs(t)}function acos(t){return Math.acos(t)}function acosh(t){return Math.acosh(t)}function asin(t){return Math.asin(t)}function asinh(t){return Math.asinh(t)}function atan(t){return Math.atan(t)}function atan2(t,i){return Math.atan2(t,i)}function atanh(t){return Math.atanh(t)}function cbrt(t){return Math.cbrt(t)}function ceil(t){return Math.ceil(t)}function clz32(t){return Math.clz32(t)}function cos(t){return Math.cos(t)}function cosh(t){return Math.cosh(t)}function exp(t){return Math.exp(t)}function expm1(t){return Math.expm1(t)}function floor(t){return Math.floor(t)}function fround(t){return Math.fround(t)}function imul(t,i){return Math.imul(t,i)}function log(t){return Math.log(t)}function log10(t){return Math.log10(t)}function log1p(t){return Math.log1p(t)}function log2(t){return Math.log2(t)}function pow(t,i){return Math.pow(t,i)}function random(){return Math.random()}function round(t){return Math.round(t)}function sign(t){return t>=0?1:-1}function sin(t){return Math.sin(t)}function sinh(t){return Math.sinh(t)}function sqrt(t){return Math.sqrt(t)}function tan(t){return Math.tan(t)}function tanh(t){return Math.tanh(t)}function trunc(t){return Math.trunc(t)}var $=function(t){return document.getElementById(t)},trim=function(t){return t.replace(/^\s*\n*/,"").replace(/\s*\n*$/,"")},myChart=echarts.init($("container")),option,dat=[],cmd=[],data=[],HUGE=1e99,LMret="";option={title:{text:"数据",textStyle:{fontFamily:"Microsoft YaHei",fontSize:24}},legend:{textStyle:{fontWeight:"bolder",fontFamily:"Microsoft YaHei",fontSize:18}},xAxis:{type:"value",offset:0,name:"x轴",nameLocation:"center",nameGap:36,nameTextStyle:{fontWeight:"bolder",fontFamily:"Microsoft YaHei",fontSize:24},axisLabel:{margin:18,fontWeight:"bolder",fontFamily:"Microsoft YaHei",fontSize:18},axisLine:{lineStyle:{width:5}},axisTick:{length:15,lineStyle:{width:5}},minorTick:{show:!0,splitNumber:5,length:10,lineStyle:{width:5}},splitLine:{lineStyle:{type:"dashed"}}},yAxis:{type:"value",offset:0,name:"y轴",nameLocation:"center",nameGap:72,nameTextStyle:{fontWeight:"bolder",fontFamily:"Microsoft YaHei",fontSize:24},axisLabel:{showMinLabel:false,showMaxLabel:false,margin:18,fontWeight:"bolder",fontFamily:"Microsoft YaHei",fontSize:18},axisLine:{lineStyle:{width:5}},axisTick:{length:15,lineStyle:{width:5}},minorTick:{show:!0,splitNumber:5,length:10,lineStyle:{width:5}},splitLine:{lineStyle:{type:"dashed"}},min:'dataMin',max:'dataMax'},series:[{name:"y",type:"scatter"}],grid:{containLabel:!0},animation:!1,calculable:!1,tooltip:{trigger:"axis",axisPointer:{type:"cross"}},toolbox:{feature:{dataZoom:{yAxisIndex:"none"},restore:{},saveAsImage:{}}},dataZoom:[{type:"slider",xAxisIndex:[0],filterMode:"none"},{type:"slider",yAxisIndex:[0],filterMode:"none"},{type:"inside",xAxisIndex:[0]},{type:"inside",yAxisIndex:[0]}]},window.onload=function(){var t=$("box"),i=$("resize"),e=$("container"),n=$("right");i.onmousedown=function(a){var r=a.clientX;return i.left=i.offsetLeft,document.onmousemove=function(a){var s=a.clientX,o=i.left+(s-r),l=t.clientWidth-i.offsetWidth;o<150&&(o=150),o>l-150&&(o=l-150),i.style.left=o,e.style.width=o+"px",n.style.width=t.clientWidth-o-5+"px"},document.onmouseup=function(t){document.onmousemove=null,document.onmouseup=null,i.releaseCapture&&i.releaseCapture()},i.setCapture&&i.setCapture(),!1}};