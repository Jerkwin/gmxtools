"use strict";function demo(t){dat[1]="#测试数据\n#i   均匀随机数 正态随机数\n 0.0      0.307     -0.355\n 0.5      0.151     -0.856\n 1.0      0.263     -0.889\n 1.5      0.315     -0.021\n 2.0      0.478     -1.454\n 2.5      0.655      1.192\n 3.0      0.889     -0.474\n 3.5      0.331     -0.182\n 4.0      0.965     -0.512\n 4.5      0.302     -0.447\n 5.0      0.554      2.187\n 5.5      0.075     -1.225\n 6.0      0.576      0.577\n 6.5      0.920      1.232\n 7.0      0.573     -0.777\n 7.5      0.237     -0.204\n 8.0      0.131      0.304\n 8.5      0.616      0.960\n 9.0      0.042     -0.473\n 9.5      0.128     -0.780\n10.0      0.135      0.655",cmd[1]="1:2 O\n[2:8] [-3:3] 1:3 M~\n$1:$2*2 O10-.5\n$1:exp(sin($3)) A10~1",dat[2]="0.25  19.21\n0.5   18.15\n1     15.36\n1.5   14.10\n2     12.89\n3      9.32\n4      7.45\n6      5.24\n8      3.01",cmd[2]="1:2 O\nfun [0:10] 20*exp(-.2*x) ~3\nfit $2=a*exp(-b*$1) a==20 b=.2 M~",dat[3]="",cmd[3]="min 100*(x2-x1*x1)^2/2+(1-x1)^2/2 x1=-1.2  x2=1 O\nmin {sqrt(2)*10*(x2-x1*x1); sqrt(2)*(1-x1)} x1=-1.2  x2=1 M\n#min sqrt(2)*sqrt(100*(x2-x1*x1)^2+(1-x1)^2) x1=-1.2  x2=1 A",$("data").value=dat[t],$("cmd").value=cmd[t],runCMD()}function noShow(t){$(t).style.display="none"}function showLM(){$("LM").style.display="block"}function runCMD(){LMret="";var i,j,k,ii,jj,row,col,txt,str,tips="数据";txt=trim($("data").value).split(/\n/);var legend=[];for(i=-1,"#"==trim(txt[0])[0]&&(i=0,"#"==trim(txt[1])[0]&&(i=1)),i>=0&&(1==i&&(tips=trim(txt[0].slice(1))),legend=trim(txt[i].slice(1)).split(/\s+/),txt=txt.slice(i+1)),row=txt.length,col=1,i=0;i<row;i++)txt[i]=trim(txt[i]),(j=txt[i].split(/\s+/).length)>col&&(col=j);var minDat=[],maxDat=[];for(i=0;i<col;i++)minDat[i]=HUGE,maxDat[i]=-HUGE;var xmin,xmax,dx=1;for(i=0;i<row;i++)for(data[i]=[],str=txt[i].split(/\s+/),col=str.length,j=0;j<col;j++)data[i][j]=parseFloat(str[j]),data[i][j]<minDat[j]&&(minDat[j]=data[i][j]),data[i][j]>maxDat[j]&&(maxDat[j]=data[i][j]);if(txt=trim($("cmd").value.replace(/#.*/g,""))){txt=txt.split(/\n/);var nser=txt.length,xname="",yname="",xmin=0,xmax=0,ymin,ymax,isFit=!1,isMin=!1,isLSQ=!1,Imin=0,series=[],ptype=[],ltype=[],swid=[],sname=[],smooth=[],symbol=[],ssymbol=[],x,y,ix=0,iy=-1,fx="",fy="",px=[],popt=[],nfit,fit=[],fitDat=[];for(k=0;k<nser;k++)if(series[k]=[],str=trim(txt[k]),"fit"==str.substr(0,3)&&(isFit=!0,xmin=-HUGE,xmax=HUGE),"min"==str.substr(0,3)&&(isMin=!0,Imin=1),isMin&&-1!=str.indexOf("{")&&(isMin=!1,isLSQ=!0,Imin=2),isFit||isMin||isLSQ){if(str=str.replace(/^fit\s+/,"").replace(/^min\s+/,""),str=str.replace(/\s*:\s*/g,":").replace(/\s*=\s*/g,"=").replace(/\s*;\s*/g,";"),str=str.replace(/maxit=+/,"maxit==").replace(/tau=+/,"tau=="),str=str.replace(/tolg=+/,"tolg==").replace(/tolx=+/,"tolx=="),str=trim(str),isFit){if("["==str[0]){var range=trim(str.replace(/].*/,"")).slice(1).split(/:/);range[0]&&1==range.length&&(xmax=parseFloat(range[0])),range[0]&&2==range.length&&(xmax=parseFloat(range[1]),xmin=parseFloat(range[0])),str=trim(str.replace(/^.*]\s*/,""))}iy=parseInt(str.replace(/=\s*.*$/,"").replace(/\$/,""))-1,yname+=(iy>=0&&legend[iy]?legend[iy]:"yfit")+(k<nser-1?"｜":""),str=trim(str.replace(/^[^=]*=\s*/,""))}else xname+="优化步数"+(k<nser-1?"｜":""),yname+="f(x)"+(k<nser-1?"｜":"");for(fx=trim(str.replace(/^.*=\S+/,"")),ptype[k]=plotType(fx),ltype[k]=lineType(fx),smooth[k]=smline(fx),symbol[k]=stype(fx),swid[k]=sizewidth(fx),fx=trim(str.replace(/.*]/,"").replace(/ *[^ ]+$/,"")),fx.length>0&&(str=trim(str.replace(/\s+\S+$/,""))),popt=str.split(/\s+/),str=str.split(/\s+/),fx="",i=0;i<str.length&&-1==str[i].indexOf("=");i++)fx+=str[i];if(sname[k]=fx,popt=popt.slice(i),isFit)for(fx=fx.replace(/\$/g,"__x"),str=fx.match(/__x\d+/g),ix=parseInt(str[0].replace(/__x/,""))-1,xname+=(ix>=0&&legend[ix]?legend[ix]:"x"+(ix+1))+(k<nser-1?"｜":""),str.sort(),px=[],ii=-1,i=0;i<str.length;i++)j=str[i],i&&ii===j||px.push(j),ii=j;str=popt,popt=[];var maxIter,tau,tolg,tolx;for(i=0;i<str.length;i++)if(-1==str[i].indexOf("=="))popt.push(str[i]);else{if(ii=trim(str[i].replace(/=.*/,"")),j=trim(str[i].replace(/.*=/,"")),-1!=ii.indexOf("maxit")){maxIter=j;continue}if(-1!=ii.indexOf("tau")){tau=j;continue}if(-1!=ii.indexOf("tolg")){tolg=j;continue}if(-1!=ii.indexOf("tolx")){tolx=j;continue}j="("+j+"*1.)",fx=fx.replace(new RegExp(ii,"g"),j)}if(isLSQ?(fx=trim(fx.replace(/[}{]/g,"")),fx=fx.split(/;/)):fx=[fx],isFit)for(nfit=0,i=0;i<row;i++)if(xmin<=data[i][ix]&&data[i][ix]<xmax){for(fitDat[nfit]=[],j=0;j<data[i].length;j++)fitDat[i][j]=data[i][j];nfit++}if(fit=LMopt(Imin,fitDat,iy,fx,px,popt,maxIter,tau,tolg,tolx),isFit)for(nfit=0,i=0;i<row;i++)xmin<=data[i][ix]&&data[i][ix]<xmax&&(x=data[i][ix],y=fit[nfit],series[k].push([x,y]),nfit++);else for(nfit=fit.length,i=0;i<nfit;i++)series[k].push([i,fit[i]])}else if("fun"==str.substr(0,3)){str=str.slice(3),fx=str.replace(/^.* +/,""),ptype[k]=plotType(fx),ltype[k]=lineType(fx),smooth[k]=smline(fx),symbol[k]=stype(fx),swid[k]=sizewidth(fx),xname+="x"+(k<nser-1?"｜":""),yname+="f(x)"+(k<nser-1?"｜":""),fx=trim(str.replace(/.*]/,"").replace(/ *[^ ]+$/,"")),sname[k]=fx;var range=trim(str.replace(/].*/,"")).slice(1).split(/ *: */);for(range[0]&&1==range.length&&(xmax=parseFloat(range[0])),range[0]&&2==range.length&&(xmax=parseFloat(range[1]),xmin=parseFloat(range[0])),dx=(xmax-xmin)/10,range[0]&&3==range.length&&(xmax=parseFloat(range[1]),xmin=parseFloat(range[0]),dx=parseFloat(range[2])),fx=new Function("x","return "+mathFunction(fx)),x=xmin;x<=xmax;x+=dx)series[k].push([x,fx(x)])}else{if(xmin=-HUGE,xmax=HUGE,ymin=-HUGE,ymax=HUGE,-1!=str.indexOf("]")){var range=trim(str.replace(/][^\]]*$/,"").replace(/\[/g,"")).split(/]/);if(range.length){var xrange=trim(range[0]).split(/:/);xmin=parseFloat(xrange[0])||xmin,xmax=parseFloat(xrange[1])||xmax,2==range.length&&(xrange=trim(range[1]).split(/:/),ymin=parseFloat(xrange[0])||ymin,ymax=parseFloat(xrange[1])||ymax)}}str=trim(str.replace(/.*]/,"")).split(/[\s|:]+/),i=-1,j=-1,fx="",fy="",-1==str[0].indexOf("$")?i=parseInt(str[0])-1:fx=trim(str[0]),-1==str[1].indexOf("$")?j=parseInt(str[1])-1:fy=trim(str[1]),ptype[k]=plotType(str[2]),ltype[k]=lineType(str[2]),smooth[k]=smline(str[2]),symbol[k]=stype(str[2]),swid[k]=sizewidth(str[2]),sname[k]=j>=0&&legend[j]?legend[j]:"y"+(k+1),str=k<nser-1?"｜":"",xname+=(i>=0&&legend[i]?legend[i]:"x"+(k+1))+str,yname+=sname[k]+str;for(var ii=0;ii<row;ii++){i>=0?x=data[ii][i]:(x=fx.replace(/\$(\d+)/g,"data["+ii+"][$1-1]"),x=eval(mathFunction(x))),j>=0?y=data[ii][j]:(y=fy.replace(/\$(\d+)/g,"data["+ii+"][$1-1]"),y=eval(mathFunction(y)));var xx=parseFloat(x),yy=parseFloat(y);xmin<=xx&&xx<=xmax&&ymin<=yy&&yy<=ymax&&series[k].push([x,y])}}for(option.title.text=tips,option.xAxis.name=xname.replace(/｜$/,""),option.yAxis.name=yname.replace(/｜$/,""),option.series=[],k=0;k<nser;k++)option.series[k]={},option.series[k].name=sname[k],option.series[k].type=ptype[k],option.series[k].data=[],option.series[k].data=series[k],option.series[k].smooth=smooth[k],option.series[k].symbol=symbol[k],option.series[k].sampling="min",option.series[k].showSymbol=!!symbol[k],option.series[k].lineStyle={},option.series[k].lineStyle.type=ltype[k],option.series[k].symbolSize=swid[k].split(/\s+/)[0],option.series[k].lineStyle.width=swid[k].split(/\s+/)[1];myChart.setOption(option,!0)}}function LMopt(t,e,i,n,a,r,s,o,l,x){s=s||100,o=o||.001,l=l||1e-8,x=x||1e-12;var m,f,p,c,u,h=a.length,d=n.length,y=r.length,g=[],M=[],k=[],b=[],v=[],j={},w=1,F=[],L=[],S=i>-1&&h>0,O=1==t,I=2==t;if(I&&(d=n.length,w=d),O)for(d=1,w=1,m=0;m<y;m++)v[m]=[];if(S)for(d=1,w=e.length,m=0;m<h;m++)g[m]=parseInt(a[m].replace(/__x/,""))-1;for(m=0;m<y;m++)M[m]=parseFloat(trim(r[m].replace(/.*=+/,""))),k[m]=trim(r[m].replace(/=.*/,""));if(I)for(m=0;m<d;m++){for(b[m]=[],f=0;f<y;f++)b[m][f]=math.simplify(math.derivative(n[m],k[f])).compile();n[m]=math.compile(n[m])}else{for(n=n[0],p=n.replace(/__x/g,"$"),m=0;m<y;m++){if(b[m]=math.simplify(math.derivative(n,k[m])),O)for(f=0;f<y;f++)v[m][f]=math.simplify(math.derivative(b[m],k[f])).compile();b[m]=b[m].compile()}n=math.compile(n)}var H=[],A=[],D=[],T=[],z=[],E=[];for(m=0;m<y;m++)j[k[m]]=M[m];if(O){for(m=0;m<y;m++)A[m]=[];c=n.evaluate(j)}else{for(m=0;m<w;m++)if(D[m]=[],T[m]=[],I&&(F[m]=n[m].evaluate(j)),S){for(f=0;f<h;f++)j[a[f]]=e[m][g[f]];F[m]=n.evaluate(j)-e[m][i]}c=.5*math.dot(F,F)}var G,q,_,U,C,W=Math.pow(2,-52),Y=0,P=!1,Q=!0,Z=2;for(LMret+='<tr align="center"><th>优化步数<br>k<'+s+"</th><th>目标函数值<br>f="+p+"</th><th>最大梯度<br>‖∇f‖<sub>∞</sub> < "+l+"</th><th>参数增比<br>‖ΔP‖<sub>2</sub>/‖P‖<sub>2</sub> < "+x+"</th><th>参数值<br>(",m=0;m<y;m++)LMret+=k[m]+(m==y-1?")":", ");for(LMret+="</th></tr>";!P&&Y<s;){if(Q){for(m=0;m<y;m++)j[k[m]]=M[m];if(O){for(m=0;m<y;m++)for(H[m]=b[m].evaluate(j),f=0;f<y;f++)A[m][f]=v[m][f].evaluate(j);if(0==Y){for(q=-1,m=0;m<y;m++){for(G=0,f=0;f<y;f++)G+=Math.abs(A[m][f]);G>q&&(q=G)}G=o*q,0==G&&(G=math.max(math.abs(H))/math.max(math.sqrt(math.dot(M,M),math.sqrt(W))))}}else{for(m=0;m<w;m++){if(I)for(f=0;f<y;f++)D[m][f]=b[m][f].evaluate(j);if(S){for(f=0;f<h;f++)j[a[f]]=e[m][g[f]];for(f=0;f<y;f++)D[m][f]=b[f].evaluate(j)}}T=math.transpose(D),H=math.multiply(T,F),A=math.multiply(T,D),0==Y&&(G=o*math.max(math.diag(A)))}}var N,R,X,B,V,J=!1;if((q=math.max(math.abs(A)))<W)N=math.multiply(-G,H);else{for(;!J;)for(B=math.add(A,math.multiply(G,math.identity(y))),V=math.eigs(B).values,J=!0,m=0;m<V.length;m++)if(V[m]<1e-15){J=!1,G=math.max(10*G,W*q);break}N=math.add(A,math.multiply(G,math.identity(y))),N=math.inv(N),N=math.multiply(-1,math.multiply(H,N))}for(_=math.max(math.abs(H)),U=math.sqrt(math.dot(M,M)),C=math.sqrt(math.dot(N,N)),(_<=l||C<=x*(x+U))&&(P=!0),m=0;m<y;m++)z[m]=M[m]+parseFloat(N.subset(math.index(m))),j[k[m]]=z[m];if(O)u=n.evaluate(j);else{for(m=0;m<w;m++)if(I&&(E[m]=n[m].evaluate(j)),S){for(f=0;f<h;f++)j[a[f]]=e[m][g[f]];L[m]=n.evaluate(j),E[m]=L[m]-e[m][i]}u=.5*math.dot(E,E)}if(R=math.subtract(math.multiply(G,N),H),R=.5*math.multiply(math.transpose(N),R),X=O?c-u:.5*math.dot(math.transpose(math.subtract(F,E)),math.add(F,E)),R>0&&X>0){for(c=u,Q=!0,m=0;m<y;m++)M[m]=z[m];for(m=0;m<w;m++)F[m]=E[m];G*=math.max(1/3,1-Math.pow(2*X/R-1,3)),Z=2}else Q=!1,G*=Z,Z*=2;for(S||L.push(c),LMret+='<tr align="center"><td>'+Y+"</td><td>"+c+"</td><td>"+_+"</td><td>"+C/(x+U)+'</td><td align="left">(',m=0;m<y;m++)LMret+=M[m]+(m==y-1?"":", ");LMret+=")</td></tr>",Y++}return LMret+='<tr><td colspan="5" align="center"><button class="btn" onclick=\'noShow("LM")\'>关闭</button></td></tr>',$("LMret").innerHTML=LMret,L}function smline(t){return-1!=t.indexOf("~")}function plotType(t){return-1!=t.indexOf("-")||-1!=t.indexOf("~")?"line":"scatter"}function lineType(t){return-1!=t.indexOf(".")?"dotted":-1!=t.indexOf("--")?"dashed":"solid"}function sizewidth(t){var e,i;return e=trim(t.replace(/[.~-]+\d*/,"").replace(/[A-Z^]*/,"")),i=trim(t.replace(/[A-Z^]+\d*/,"").replace(/[.~-]*/,"")),e||(e=10),i||(i=2),e+" "+i}function stype(t){return-1!=t.indexOf("O")?"circle":-1!=t.indexOf("M")?"rect":-1!=t.indexOf("D")?"roundRect":-1!=t.indexOf("A")?"triangle":-1!=t.indexOf("V")?"diamond":-1!=t.indexOf("Q")?"pin":-1!=t.indexOf("^")?"arrow":""}function mathFunction(t){return t=t.replace(/pi/gi,"(Math.PI)").replace(/tau/gi,"(2*Math.PI)")}function abs(t){return Math.abs(t)}function acos(t){return Math.acos(t)}function acosh(t){return Math.acosh(t)}function asin(t){return Math.asin(t)}function asinh(t){return Math.asinh(t)}function atan(t){return Math.atan(t)}function atan2(t,e){return Math.atan2(t,e)}function atanh(t){return Math.atanh(t)}function cbrt(t){return Math.cbrt(t)}function ceil(t){return Math.ceil(t)}function clz32(t){return Math.clz32(t)}function cos(t){return Math.cos(t)}function cosh(t){return Math.cosh(t)}function exp(t){return Math.exp(t)}function expm1(t){return Math.expm1(t)}function floor(t){return Math.floor(t)}function fround(t){return Math.fround(t)}function imul(t,e){return Math.imul(t,e)}function log(t){return Math.log(t)}function log10(t){return Math.log10(t)}function log1p(t){return Math.log1p(t)}function log2(t){return Math.log2(t)}function pow(t,e){return Math.pow(t,e)}function random(){return Math.random()}function round(t){return Math.round(t)}function sign(t){return t>=0?1:-1}function sin(t){return Math.sin(t)}function sinh(t){return Math.sinh(t)}function sqrt(t){return Math.sqrt(t)}function tan(t){return Math.tan(t)}function tanh(t){return Math.tanh(t)}function trunc(t){return Math.trunc(t)}var $=function(t){return document.getElementById(t)},trim=function(t){return t.replace(/^\s*\n*/,"").replace(/\s*\n*$/,"")},myChart=echarts.init($("container")),option,dat=[],cmd=[],data=[],HUGE=1e99,LMret="";option={title:{text:"数据",textStyle:{fontFamily:"Microsoft YaHei",fontSize:24}},legend:{textStyle:{fontWeight:"bolder",fontFamily:"Microsoft YaHei",fontSize:18}},xAxis:{type:"value",offset:0,name:"x轴",nameLocation:"center",nameGap:36,nameTextStyle:{fontWeight:"bolder",fontFamily:"Microsoft YaHei",fontSize:24},axisLabel:{margin:18,fontWeight:"bolder",fontFamily:"Microsoft YaHei",fontSize:18},axisLine:{lineStyle:{width:5}},axisTick:{length:15,lineStyle:{width:5}},minorTick:{show:!0,splitNumber:5,length:10,lineStyle:{width:5}},splitLine:{lineStyle:{type:"dashed"}}},yAxis:{type:"value",offset:0,name:"y轴",nameLocation:"center",nameGap:72,nameTextStyle:{fontWeight:"bolder",fontFamily:"Microsoft YaHei",fontSize:24},axisLabel:{margin:18,fontWeight:"bolder",fontFamily:"Microsoft YaHei",fontSize:18},axisLine:{lineStyle:{width:5}},axisTick:{length:15,lineStyle:{width:5}},minorTick:{show:!0,splitNumber:5,length:10,lineStyle:{width:5}},splitLine:{lineStyle:{type:"dashed"}}},series:[{name:"y",type:"scatter"}],grid:{containLabel:!0},animation:!1,calculable:!1,tooltip:{trigger:"axis",axisPointer:{type:"cross"}},toolbox:{feature:{dataZoom:{yAxisIndex:"none"},restore:{},saveAsImage:{}}},dataZoom:[{type:"slider",xAxisIndex:[0],filterMode:"none"},{type:"slider",yAxisIndex:[0],filterMode:"none"},{type:"inside",xAxisIndex:[0]},{type:"inside",yAxisIndex:[0]}]},window.onload=function(){var t=$("box"),e=$("resize"),i=$("container"),n=$("right");e.onmousedown=function(a){var r=a.clientX;return e.left=e.offsetLeft,document.onmousemove=function(a){var s=a.clientX,o=e.left+(s-r),l=t.clientWidth-e.offsetWidth;o<150&&(o=150),o>l-150&&(o=l-150),e.style.left=o,i.style.width=o+"px",n.style.width=t.clientWidth-o-5+"px"},document.onmouseup=function(t){document.onmousemove=null,document.onmouseup=null,e.releaseCapture&&e.releaseCapture()},e.setCapture&&e.setCapture(),!1}};